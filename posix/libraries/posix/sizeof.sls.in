;;;
;;;Part of: Nausicaa/POSIX
;;;Contents: size of definitions
;;;Date: Fri Dec  5, 2008
;;;
;;;Abstract
;;;
;;;
;;;
;;;Copyright (c) 2008, 2009 Marco Maggi <marcomaggi@gna.org>
;;;
;;;This program is free software:  you can redistribute it and/or modify
;;;it under the terms of the  GNU General Public License as published by
;;;the Free Software Foundation, either version 3 of the License, or (at
;;;your option) any later version.
;;;
;;;This program is  distributed in the hope that it  will be useful, but
;;;WITHOUT  ANY   WARRANTY;  without   even  the  implied   warranty  of
;;;MERCHANTABILITY  or FITNESS FOR  A PARTICULAR  PURPOSE.  See  the GNU
;;;General Public License for more details.
;;;
;;;You should  have received  a copy of  the GNU General  Public License
;;;along with this program.  If not, see <http://www.gnu.org/licenses/>.
;;;



(library (posix sizeof)
  (export

    define-primitive-parameter

    ;; types
    blkcnt_t		pointer-set-c-blkcnt_t!	pointer-ref-c-blkcnt_t
    clock_t		pointer-set-c-clock_t!	pointer-ref-c-clock_t
    dev_t		pointer-set-c-dev_t!	pointer-ref-c-dev_t
    gid_t		pointer-set-c-gid_t!	pointer-ref-c-gid_t
    ino_t		pointer-set-c-ino_t!	pointer-ref-c-ino_t
    mode_t		pointer-set-c-mode_t!	pointer-ref-c-mode_t
    nlink_t		pointer-set-c-nlink_t!	pointer-ref-c-nlink_t
    off_t		pointer-set-c-off_t!	pointer-ref-c-off_t
    pid_t		pointer-set-c-pid_t!	pointer-ref-c-pid_t
    time_t		pointer-set-c-time_t!	pointer-ref-c-time_t
    uid_t		pointer-set-c-uid_t!	pointer-ref-c-uid_t

    ;; structures
    sizeof-struct-dirent alignof-struct-dirent strideof-struct-dirent
    sizeof-struct-flock alignof-struct-flock strideof-struct-flock
    sizeof-struct-stat alignof-struct-stat strideof-struct-stat
    sizeof-struct-timespec alignof-struct-timespec strideof-struct-timespec
    sizeof-struct-timeval alignof-struct-timeval strideof-struct-timeval

    ;; constants
    O_ACCMODE		O_CREAT		O_EXCL
    O_EXEC		O_EXLOCK	O_IGNORE_CTTY
    O_NOCTTY		O_NOLINK	O_NONBLOCK
    O_NOTRANS		O_RDONLY	O_RDWR
    O_READ		O_SHLOCK	O_TRUNC
    O_WRITE		O_WRONLY	O_APPEND
    O_NDELAY

    O_NOATIME

    F_DUPFD		F_GETFD		F_GETFL
    F_GETLK		F_GETOWN	F_SETFD
    F_SETFL		F_SETLKW	F_SETLK
    F_SETOWN

    FD_CLOEXEC

    F_RDLCK		F_WRLCK		F_UNLCK

    R_OK		W_OK		X_OK		F_OK

    SEEK_SET		SEEK_CUR	SEEK_END
    WNOHANG		WUNTRACED	WCONTINUED
    CLOCKS_PER_SEC

    L_ctermid		L_tmpnam

    S_IRUSR		S_IWUSR		S_IXUSR
    S_IRGRP		S_IWGRP		S_IXGRP
    S_IROTH		S_IWOTH		S_IXOTH
    S_IRWXU		S_IRWXG		S_IRWXO
    S_ISUID		S_ISGID		S_ISVTX

    ;;struct accessors
    struct-flock-l_type-set!		struct-flock-l_type-ref
    struct-flock-l_whence-set!		struct-flock-l_whence-ref
    struct-flock-l_start-set!		struct-flock-l_start-ref
    struct-flock-l_len-set!		struct-flock-l_len-ref
    struct-flock-l_pid-set!		struct-flock-l_pid-ref

    struct-timeval-tv_sec-set!		struct-timeval-tv_sec-ref
    struct-timeval-tv_usec-set!		struct-timeval-tv_usec-ref

    struct-timespec-tv_sec-set!		struct-timespec-tv_sec-ref
    struct-timespec-tv_nsec-set!	struct-timespec-tv_nsec-ref

    struct-dirent-d_name-ref

    struct-stat-st_mode-set!		struct-stat-st_mode-ref
    struct-stat-st_ino-set!		struct-stat-st_ino-ref
    struct-stat-st_dev-set!		struct-stat-st_dev-ref
    struct-stat-st_nlink-set!		struct-stat-st_nlink-ref
    struct-stat-st_uid-set!		struct-stat-st_uid-ref
    struct-stat-st_gid-set!		struct-stat-st_gid-ref
    struct-stat-st_size-set!		struct-stat-st_size-ref
    struct-stat-st_atime-set!		struct-stat-st_atime-ref
    struct-stat-st_atime_usec-set!	struct-stat-st_atime_usec-ref
    struct-stat-st_mtime-set!		struct-stat-st_mtime-ref
    struct-stat-st_mtime_usec-set!	struct-stat-st_mtime_usec-ref
    struct-stat-st_ctime-set!		struct-stat-st_ctime-ref
    struct-stat-st_ctime_usec-set!	struct-stat-st_ctime_usec-ref
    struct-stat-st_blocks-set!		struct-stat-st_blocks-ref
    struct-stat-st_blksize-set!		struct-stat-st_blksize-ref
    )
  (import (rnrs)
    (uriel lang)
    (uriel memory)
    (uriel ffi))


;;;; helpers

(define-syntax define-primitive-parameter
  (syntax-rules ()
    ((_ ?parameter-name ?primitive-name)
     (define ?parameter-name
       (make-parameter ?primitive-name
	 (lambda (func)
	   (unless (procedure? func)
	     (assertion-violation (quote ?parameter-name)
	       (format "expected procedure as value for ~s parameter"
		 ?parameter-name)
	       func))
	   func))))))


;;;; basic type definitions

(define blkcnt_t			(quote @TYPEOF_BLKCNT_T@))
(define pointer-set-c-blkcnt_t!		@SETTEROF_BLKCNT_T@)
(define pointer-ref-c-blkcnt_t		@GETTEROF_BLKCNT_T@)

(define clock_t				(quote @TYPEOF_CLOCK_T@))
(define pointer-set-c-clock_t!		@SETTEROF_CLOCK_T@)
(define pointer-ref-c-clock_t		@GETTEROF_CLOCK_T@)

(define dev_t				(quote @TYPEOF_DEV_T@))
(define pointer-set-c-dev_t!		@SETTEROF_DEV_T@)
(define pointer-ref-c-dev_t		@GETTEROF_DEV_T@)

(define gid_t				(quote @TYPEOF_GID_T@))
(define pointer-set-c-gid_t!		@SETTEROF_GID_T@)
(define pointer-ref-c-gid_t		@GETTEROF_GID_T@)

(define ino_t				(quote @TYPEOF_INO_T@))
(define pointer-set-c-ino_t!		@SETTEROF_INO_T@)
(define pointer-ref-c-ino_t		@GETTEROF_INO_T@)

(define mode_t				(quote @TYPEOF_MODE_T@))
(define pointer-set-c-mode_t!		@SETTEROF_MODE_T@)
(define pointer-ref-c-mode_t		@GETTEROF_MODE_T@)

(define nlink_t				(quote @TYPEOF_NLINK_T@))
(define pointer-set-c-nlink_t!		@SETTEROF_NLINK_T@)
(define pointer-ref-c-nlink_t		@GETTEROF_NLINK_T@)

(define off_t				(quote @TYPEOF_OFF_T@))
(define pointer-set-c-off_t!		@SETTEROF_OFF_T@)
(define pointer-ref-c-off_t		@GETTEROF_OFF_T@)

(define pid_t				(quote @TYPEOF_PID_T@))
(define pointer-set-c-pid_t!		@SETTEROF_PID_T@)
(define pointer-ref-c-pid_t		@GETTEROF_PID_T@)

(define time_t				(quote @TYPEOF_TIME_T@))
(define pointer-set-c-time_t!		@SETTEROF_TIME_T@)
(define pointer-ref-c-time_t		@GETTEROF_TIME_T@)

(define uid_t				(quote @TYPEOF_UID_T@))
(define pointer-set-c-uid_t!		@SETTEROF_UID_T@)
(define pointer-ref-c-uid_t		@GETTEROF_UID_T@)



;;;; struct type definitions

(define sizeof-struct-flock		@SIZEOF_STRUCT_FLOCK@)
(define alignof-struct-flock		@ALIGNOF_STRUCT_FLOCK@)
(define strideof-struct-flock		@STRIDEOF_STRUCT_FLOCK@)

(define sizeof-struct-timeval		@SIZEOF_STRUCT_TIMEVAL@)
(define alignof-struct-timeval		@ALIGNOF_STRUCT_TIMEVAL@)
(define strideof-struct-timeval		@STRIDEOF_STRUCT_TIMEVAL@)

(define sizeof-struct-timespec		@SIZEOF_STRUCT_TIMESPEC@)
(define alignof-struct-timespec		@ALIGNOF_STRUCT_TIMESPEC@)
(define strideof-struct-timespec	@STRIDEOF_STRUCT_TIMESPEC@)

(define sizeof-struct-dirent		@SIZEOF_STRUCT_DIRENT@)
(define alignof-struct-dirent		@ALIGNOF_STRUCT_DIRENT@)
(define strideof-struct-dirent		@STRIDEOF_STRUCT_DIRENT@)

(define sizeof-struct-stat		@SIZEOF_STRUCT_STAT@)
(define alignof-struct-stat		@ALIGNOF_STRUCT_STAT@)
(define strideof-struct-stat		@STRIDEOF_STRUCT_STAT@)



;;;; constants

(define O_ACCMODE		@VALUEOF_O_ACCMODE@)
(define O_APPEND		@VALUEOF_O_APPEND@)
(define O_ASYNC			@VALUEOF_O_ASYNC@)
(define O_CREAT			@VALUEOF_O_CREAT@)
(define O_EXCL			@VALUEOF_O_EXCL@)
(define O_EXEC			@VALUEOF_O_EXEC@)
(define O_EXLOCK		@VALUEOF_O_EXLOCK@)
(define O_FSYNC			@VALUEOF_O_FSYNC@)
(define O_IGNORE_CTTY		@VALUEOF_O_IGNORE_CTTY@)
(define O_NDELAY		@VALUEOF_O_NDELAY@)
(define O_NOATIME		@VALUEOF_O_NOATIME@)
(define O_NOCTTY		@VALUEOF_O_NOCTTY@)
(define O_NOLINK		@VALUEOF_O_NOLINK@)
(define O_NONBLOCK		@VALUEOF_O_NONBLOCK@)
(define O_NOTRANS		@VALUEOF_O_NOTRANS@)
(define O_RDONLY		@VALUEOF_O_RDONLY@)
(define O_RDWR			@VALUEOF_O_RDWR@)
(define O_READ			@VALUEOF_O_READ@)
(define O_SHLOCK		@VALUEOF_O_SHLOCK@)
(define O_SYNC			@VALUEOF_O_SYNC@)
(define O_TRUNC			@VALUEOF_O_TRUNC@)
(define O_WRITE			@VALUEOF_O_WRITE@)
(define O_WRONLY		@VALUEOF_O_WRONLY@)

(define F_DUPFD			@VALUEOF_F_DUPFD@)
(define F_GETFD			@VALUEOF_F_GETFD@)
(define F_GETFL			@VALUEOF_F_GETFL@)
(define F_GETLK			@VALUEOF_F_GETLK@)
(define F_GETOWN		@VALUEOF_F_GETOWN@)
(define F_SETFD			@VALUEOF_F_SETFD@)
(define F_SETFL			@VALUEOF_F_SETFL@)
(define F_SETLKW		@VALUEOF_F_SETLKW@)
(define F_SETLK			@VALUEOF_F_SETLK@)
(define F_SETOWN		@VALUEOF_F_SETOWN@)

(define FD_CLOEXEC		@VALUEOF_FD_CLOEXEC@)

(define F_RDLCK			@VALUEOF_F_RDLCK@)
(define F_WRLCK			@VALUEOF_F_WRLCK@)
(define F_UNLCK			@VALUEOF_F_UNLCK@)

(define R_OK			@VALUEOF_R_OK@)
(define W_OK			@VALUEOF_W_OK@)
(define X_OK			@VALUEOF_X_OK@)
(define F_OK			@VALUEOF_F_OK@)

(define SEEK_SET		@VALUEOF_SEEK_SET@)
(define SEEK_CUR		@VALUEOF_SEEK_CUR@)
(define SEEK_END		@VALUEOF_SEEK_END@)

(define WNOHANG			@VALUEOF_WNOHANG@)
(define WUNTRACED		@VALUEOF_WUNTRACED@)
(define WCONTINUED		@VALUEOF_WCONTINUED@)

(define L_ctermid		@VALUEOF_L_ctermid@)
(define L_tmpnam		@VALUEOF_L_tmpnam@)

(define CLOCKS_PER_SEC		@VALUEOF_CLOCKS_PER_SEC@)

(define S_IRUSR			@VALUEOF_S_IRUSR@)
(define S_IWUSR			@VALUEOF_S_IWUSR@)
(define S_IXUSR			@VALUEOF_S_IXUSR@)

(define S_IRGRP			@VALUEOF_S_IRGRP@)
(define S_IWGRP			@VALUEOF_S_IWGRP@)
(define S_IXGRP			@VALUEOF_S_IXGRP@)

(define S_IROTH			@VALUEOF_S_IROTH@)
(define S_IWOTH			@VALUEOF_S_IWOTH@)
(define S_IXOTH			@VALUEOF_S_IXOTH@)

(define S_IRWXU			@VALUEOF_S_IRWXU@)
(define S_IRWXG			@VALUEOF_S_IRWXG@)
(define S_IRWXO			@VALUEOF_S_IRWXO@)

(define S_ISUID			@VALUEOF_S_ISUID@)
(define S_ISGID			@VALUEOF_S_ISGID@)
(define S_ISVTX			@VALUEOF_S_ISVTX@)



;;;; struct accessors

(define-c-struct-accessors
  struct-flock-l_type-set!
  struct-flock-l_type-ref
  @OFFSETOF_STRUCT_FLOCK_L_TYPE@
  @SETTEROF_STRUCT_FLOCK_L_TYPE@
  @GETTEROF_STRUCT_FLOCK_L_TYPE@)

(define-c-struct-accessors
  struct-flock-l_whence-set!
  struct-flock-l_whence-ref
  @OFFSETOF_STRUCT_FLOCK_L_WHENCE@
  @SETTEROF_STRUCT_FLOCK_L_WHENCE@
  @GETTEROF_STRUCT_FLOCK_L_WHENCE@)

(define-c-struct-accessors
  struct-flock-l_start-set!
  struct-flock-l_start-ref
  @OFFSETOF_STRUCT_FLOCK_L_START@
  @SETTEROF_STRUCT_FLOCK_L_START@
  @GETTEROF_STRUCT_FLOCK_L_START@)

(define-c-struct-accessors
  struct-flock-l_len-set!
  struct-flock-l_len-ref
  @OFFSETOF_STRUCT_FLOCK_L_LEN@
  @SETTEROF_STRUCT_FLOCK_L_LEN@
  @GETTEROF_STRUCT_FLOCK_L_LEN@)

(define-c-struct-accessors
  struct-flock-l_pid-set!
  struct-flock-l_pid-ref
  @OFFSETOF_STRUCT_FLOCK_L_PID@
  @SETTEROF_STRUCT_FLOCK_L_PID@
  @GETTEROF_STRUCT_FLOCK_L_PID@)

;;; --------------------------------------------------------------------

(define-c-struct-accessors
  struct-timeval-tv_sec-set!
  struct-timeval-tv_sec-ref
  @OFFSETOF_STRUCT_TIMEVAL_TV_SEC@
  @SETTEROF_STRUCT_TIMEVAL_TV_SEC@
  @GETTEROF_STRUCT_TIMEVAL_TV_SEC@)

(define-c-struct-accessors
  struct-timeval-tv_usec-set!
  struct-timeval-tv_usec-ref
  @OFFSETOF_STRUCT_TIMEVAL_TV_USEC@
  @SETTEROF_STRUCT_TIMEVAL_TV_USEC@
  @GETTEROF_STRUCT_TIMEVAL_TV_USEC@)

;;; --------------------------------------------------------------------

(define-c-struct-accessors
  struct-timespec-tv_sec-set!
  struct-timespec-tv_sec-ref
  @OFFSETOF_STRUCT_TIMESPEC_TV_SEC@
  @SETTEROF_STRUCT_TIMESPEC_TV_SEC@
  @GETTEROF_STRUCT_TIMESPEC_TV_SEC@)

(define-c-struct-accessors
  struct-timespec-tv_nsec-set!
  struct-timespec-tv_nsec-ref
  @OFFSETOF_STRUCT_TIMESPEC_TV_NSEC@
  @SETTEROF_STRUCT_TIMESPEC_TV_NSEC@
  @GETTEROF_STRUCT_TIMESPEC_TV_NSEC@)

;;; --------------------------------------------------------------------

(define-c-struct-field-pointer-getter
  struct-dirent-d_name-ref
  @OFFSETOF_STRUCT_DIRENT_D_NAME@)

;;; --------------------------------------------------------------------

(define-c-struct-accessors
  struct-stat-st_mode-set!
  struct-stat-st_mode-ref
  @OFFSETOF_STRUCT_STAT_ST_MODE@
  @SETTEROF_STRUCT_STAT_ST_MODE@
  @GETTEROF_STRUCT_STAT_ST_MODE@)

(define-c-struct-accessors
  struct-stat-st_ino-set!
  struct-stat-st_ino-ref
  @OFFSETOF_STRUCT_STAT_ST_INO@
  @SETTEROF_STRUCT_STAT_ST_INO@
  @GETTEROF_STRUCT_STAT_ST_INO@)

(define-c-struct-accessors
  struct-stat-st_dev-set!
  struct-stat-st_dev-ref
  @OFFSETOF_STRUCT_STAT_ST_DEV@
  @SETTEROF_STRUCT_STAT_ST_DEV@
  @GETTEROF_STRUCT_STAT_ST_DEV@)

(define-c-struct-accessors
  struct-stat-st_nlink-set!
  struct-stat-st_nlink-ref
  @OFFSETOF_STRUCT_STAT_ST_NLINK@
  @SETTEROF_STRUCT_STAT_ST_NLINK@
  @GETTEROF_STRUCT_STAT_ST_NLINK@)

(define-c-struct-accessors
  struct-stat-st_uid-set!
  struct-stat-st_uid-ref
  @OFFSETOF_STRUCT_STAT_ST_UID@
  @SETTEROF_STRUCT_STAT_ST_UID@
  @GETTEROF_STRUCT_STAT_ST_UID@)

(define-c-struct-accessors
  struct-stat-st_gid-set!
  struct-stat-st_gid-ref
  @OFFSETOF_STRUCT_STAT_ST_GID@
  @SETTEROF_STRUCT_STAT_ST_GID@
  @GETTEROF_STRUCT_STAT_ST_GID@)

(define-c-struct-accessors
  struct-stat-st_size-set!
  struct-stat-st_size-ref
  @OFFSETOF_STRUCT_STAT_ST_SIZE@
  @SETTEROF_STRUCT_STAT_ST_SIZE@
  @GETTEROF_STRUCT_STAT_ST_SIZE@)

(define-c-struct-accessors
  struct-stat-st_atime-set!
  struct-stat-st_atime-ref
  @OFFSETOF_STRUCT_STAT_ST_ATIME@
  @SETTEROF_STRUCT_STAT_ST_ATIME@
  @GETTEROF_STRUCT_STAT_ST_ATIME@)

(define-c-struct-accessors
  struct-stat-st_atime_usec-set!
  struct-stat-st_atime_usec-ref
  @OFFSETOF_STRUCT_STAT_ST_ATIME_USEC@
  @SETTEROF_STRUCT_STAT_ST_ATIME_USEC@
  @GETTEROF_STRUCT_STAT_ST_ATIME_USEC@)

(define-c-struct-accessors
  struct-stat-st_mtime-set!
  struct-stat-st_mtime-ref
  @OFFSETOF_STRUCT_STAT_ST_MTIME@
  @SETTEROF_STRUCT_STAT_ST_MTIME@
  @GETTEROF_STRUCT_STAT_ST_MTIME@)

(define-c-struct-accessors
  struct-stat-st_mtime_usec-set!
  struct-stat-st_mtime_usec-ref
  @OFFSETOF_STRUCT_STAT_ST_MTIME_USEC@
  @SETTEROF_STRUCT_STAT_ST_MTIME_USEC@
  @GETTEROF_STRUCT_STAT_ST_MTIME_USEC@)

(define-c-struct-accessors
  struct-stat-st_ctime-set!
  struct-stat-st_ctime-ref
  @OFFSETOF_STRUCT_STAT_ST_CTIME@
  @SETTEROF_STRUCT_STAT_ST_CTIME@
  @GETTEROF_STRUCT_STAT_ST_CTIME@)

(define-c-struct-accessors
  struct-stat-st_ctime_usec-set!
  struct-stat-st_ctime_usec-ref
  @OFFSETOF_STRUCT_STAT_ST_CTIME_USEC@
  @SETTEROF_STRUCT_STAT_ST_CTIME_USEC@
  @GETTEROF_STRUCT_STAT_ST_CTIME_USEC@)

(define-c-struct-accessors
  struct-stat-st_blocks-set!
  struct-stat-st_blocks-ref
  @OFFSETOF_STRUCT_STAT_ST_BLOCKS@
  @SETTEROF_STRUCT_STAT_ST_BLOCKS@
  @GETTEROF_STRUCT_STAT_ST_BLOCKS@)

(define-c-struct-accessors
  struct-stat-st_blksize-set!
  struct-stat-st_blksize-ref
  @OFFSETOF_STRUCT_STAT_ST_BLKSIZE@
  @SETTEROF_STRUCT_STAT_ST_BLKSIZE@
  @GETTEROF_STRUCT_STAT_ST_BLKSIZE@)



;;;; done

  )

;;; end of file
